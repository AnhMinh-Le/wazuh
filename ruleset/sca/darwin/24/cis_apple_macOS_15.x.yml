# Copyright (C) 2015, Wazuh Inc.
#
# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation
#
# Based on:
# Center for Internet Security Mac0S 15 Sequoia Benchmark v1.0.0 - 19/09/2024 (Draft)

policy:
  id: "cis_macOS_15.Sequoia.yml"
  file: "cis_macOS_15.Sequoia.yml"
  name: "CIS_Apple_macOS_15.0_Sequoia_Benchmark_v1.0.0"
  description: "This document provides prescriptive guidance for establishing a secure configuration posture for MacOS 15 Sequoia systems."
  references:
    - https://www.cisecurity.org/cis-benchmarks/

requirements:
  title: "Check MacOS 15 Sequoia platform."
  description: "Requirements for running the policy against MacOS 15 Sequoia."
  condition: any
  rules:
    - 'c:sw_vers -> r:^ProductVersion:\t*\s*15\p'
    - 'c:system_profiler SPSoftwareDataType -> r:System Version:.*15\p'
    - 'c:defaults read loginwindow SystemVersionStampAsString -> r:^\s*15\p'

checks:
  ##########################################################################
  # 1 Install Updates, Patches and Additional Security Software
  ##########################################################################

  # 1.1 Ensure All Apple-provided Software Is Current. (Automated)- Not Implemented

  # 1.2 Ensure Auto Update Is Enabled. (Automated)
  - id: 34000
    title: "Ensure Auto Update Is Enabled."
    description: 'Auto Update verifies that your system has the newest security patches and software updates. If "Automatically check for updates" is not selected, background updates for new malware definition files from Apple for XProtect and Gatekeeper will not occur.'
    rationale: "It is important that a system has the newest updates applied so as to prevent unauthorized persons from exploiting identified vulnerabilities."
    impact: "Without automatic update, updates may not be made in a timely manner and the system will be exposed to additional risk."
    remediation: "Graphical Method: Perform the following steps to enable the system to automatically check for updates: Open System Settings Select General Select Software Update Select the i Set Check for updates to enabled Select Done Terminal Method: Run the following command to enable auto update: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticCheckEnabled -bool true Profile Method: Create or edit a configuration profile with the following information: The PayloadType string is com.apple.SoftwareUpdate The key to include is AutomaticCheckEnabled The key must be set to <true/>."
    compliance:
      - cis: ["1.2"]
      - cis_csc_v8: ["7.3", "7.4"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - soc_2: ["CC7.1"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticCheckEnabled'')" -> r:^1$'
      - 'not c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticCheckEnabled'')" -> r:\.+'

  # 1.3 Ensure Download New Updates When Available Is Enabled. (Automated)
  - id: 34001
    title: "Ensure Download New Updates When Available Is Enabled."
    description: 'In the GUI, both "Install macOS updates" and "Install app updates from the App Store" are dependent on whether "Download new updates when available" is selected.'
    rationale: "It is important that a system has the newest updates downloaded so that they can be applied."
    impact: 'If "Download new updates when available" is not selected, updates may not be made in a timely manner and the system will be exposed to additional risk.'
    remediation: "Perform the following to enable the system to automatically check for updates: Graphical Method: 1. Open System Settings 2. Select General 3. Select Software Update 4. Select the i 5. Set Download new updates when available to enabled 6. Select Done Terminal Method: Run the following command to enable auto update: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticDownload -bool true Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.SoftwareUpdate 2. The key to include is AutomaticDownload 3. The key must be set to <true/>."
    compliance:
      - cis: ["1.3"]
      - cis_csc_v8: ["7.3", "7.4"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - soc_2: ["CC7.1"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticDownload'')" -> r:^1$'
      - 'not c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticDownload'')" -> r:\.+'

  # 1.4 Ensure Install of macOS Updates Is Enabled. (Automated)
  - id: 34002
    title: "Ensure Install of macOS Updates Is Enabled."
    description: "Ensure that macOS updates are installed after they are available from Apple. This setting enables macOS updates to be automatically installed. Some environments will want to approve and test updates before they are delivered. It is best practice to test first where updates can and have caused disruptions to operations. Automatic updates should be turned off where changes are tightly controlled and there are mature testing and approval processes. Automatic updates should not be turned off simply to allow the administrator to contact users in order to verify installation. A dependable, repeatable process involving a patch agent or remote management tool should be in place before auto-updates are turned off."
    rationale: "Patches need to be applied in a timely manner to reduce the risk of vulnerabilities being exploited."
    impact: "Unpatched software may be exploited."
    remediation: "Graphical Method: Perform the following steps to enable macOS updates to run automatically: 1. Open System Settings 2. Select General 3. Select Software Update 4. Select the i 5. Set Install macOS updates to enabled 6. Select Done Terminal Method: Run the following command to to enable automatic checking and installing of macOS updates: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.SoftwareUpdate AutomaticallyInstallMacOSUpdates -bool TRUE Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.SoftwareUpdate 2. The key to include is AutomaticallyInstallMacOSUpdates 3. The key must be set to <true/>."
    compliance:
      - cis: ["1.4"]
      - cis_csc_v8: ["7.3", "7.4"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - soc_2: ["CC7.1"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticallyInstallMacOSUpdates'')" -> r:^1$'
      - 'not c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''AutomaticallyInstallMacOSUpdates'')" -> r:\.+'

  # 1.5 Ensure Install Application Updates from the App Store Is Enabled. (Automated)
  - id: 34003
    title: "Ensure Install Application Updates from the App Store Is Enabled."
    description: "Ensure that application updates are installed after they are available from Apple. These updates do not require reboots or administrator privileges for end users."
    rationale: "Patches need to be applied in a timely manner to reduce the risk of vulnerabilities being exploited."
    impact: "Unpatched software may be exploited."
    remediation: "Graphical Method: Perform the following steps to enable App Store updates to install automatically: 1. Open System Settings 2. Select General 3. Select Software Update 4. Select the i 5. Set Install application updates from the App Store to enabled 6. Select Done Terminal Method: Run the following command to turn on App Store auto updating: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.commerce AutoUpdate -bool TRUE Note: This remediation requires a log out and log in to show in the GUI. Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.SoftwareUpdate 2. The key to include is AutomaticallyInstallAppUpdates 3. The key must be set to <true/>."
    compliance:
      - cis: ["1.5"]
      - cis_csc_v8: ["7.3", "7.4"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - soc_2: ["CC7.1"]
    condition: all
    rules:
      - "c:defaults read /Library/Preferences/com.apple.commerce AutoUpdate -> r:^1$"

  # 1.6 Ensure Install Security Responses and System Files Is Enabled. (Automated)
  - id: 34004
    title: "Ensure Install Security Responses and System Files Is Enabled."
    description: "Ensure that system and security updates are installed after they are available from Apple. This setting enables definition updates for XProtect and Gatekeeper. With this setting in place, new malware and adware that Apple has added to the list of malware or untrusted software will not execute. These updates do not require reboots or end user admin rights. Apple has introduced a security feature that allows for smaller downloads and the installation of security updates when a reboot is not required. This feature is only available when the last regular update has already been applied. This feature emphasizes that a Mac must be up-to-date on patches so that Apple's security tools can be used to quickly patch when a rapid response is necessary."
    rationale: "Patches need to be applied in a timely manner to reduce the risk of vulnerabilities being exploited."
    impact: "Unpatched software may be exploited."
    remediation: "Graphical Method: Perform the following steps to enable system data files and security updates to install automatically: 1. Open System Settings 2. Select General 3. Select Software Update 4. Select the i 5. Set Install Security Responses and System files to enabled 6. Select Done Terminal Method: Run the following commands to enable automatic checking of system data files and security updates: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.SoftwareUpdate ConfigDataInstall -bool true $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.SoftwareUpdate CriticalUpdateInstall -bool true Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.SoftwareUpdate 2. The key to include is ConfigDataInstall 3. The key must be set to <true/> 4. The key to also include is CriticalUpdateInstall 5. The key must be set to <true/>."
    references:
      - "https://eclecticlight.co/2021/10/27/silently-updated-security-data-files-in-monterey/"
      - "https://support.apple.com/en-us/HT202491"
      - "https://support.apple.com/guide/security/protecting-against-malware-sec469d47bd8/web"
      - "https://support.apple.com/guide/deployment/rapid-security-responses-dep93ff7ea78/1/web/1.0"
    compliance:
      - cis: ["1.6"]
      - cis_csc_v8: ["7.3", "7.4", "7.7"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["CA.L2-3.12.2", "RA.L2-3.11.3", "SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - pci_dss_v4.0: ["11.3.1", "11.3.2", "11.3.2.1"]
      - soc_2: ["CC7.1"]
    condition: all
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''ConfigDataInstall'')" -> r:^1$'
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.SoftwareUpdate'').objectForKey(''CriticalUpdateInstall'')" -> r:^1$'

  # 1.7 Ensure Software Update Deferment Is Less Than or Equal to 30 Days. (Automated)
  - id: 34005
    title: "Ensure Software Update Deferment Is Less Than or Equal to 30 Days."
    description: "Apple provides the capability to manage software updates on Apple devices through mobile device management. Part of those capabilities permit organizations to defer software updates and allow for testing. Many organizations have specialized software and configurations that may be negatively impacted by Apple updates. If software updates are deferred, they should not be deferred for more than 30 days. This control only verifies that deferred software updates are not deferred for more than 30 days."
    rationale: "Apple software updates almost always include security updates. Attackers evaluate updates to create exploit code in order to attack unpatched systems. The longer a system remains unpatched, the greater an exploit possibility exists in which there are publicly reported vulnerabilities."
    impact: "Some organizations may need more than 30 days to evaluate the impact of software updates."
    remediation: "Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.applicationaccess 2. The key to include is enforcedSoftwareUpdateDelay 3. The key must be set to <integer><1-30></integer>."
    references:
      - "https://support.apple.com/guide/deployment/manage-software-updates-depc4c80847a/web"
    compliance:
      - cis: ["1.7"]
      - cis_csc_v8: ["7.3", "7.4"]
      - cis_csc_v7: ["3.4", "3.5"]
      - cmmc_v2.0: ["SI.L1-3.14.1"]
      - nist_sp_800-53: ["SI-2(2)"]
      - pci_dss_v3.2.1: ["6.2"]
      - soc_2: ["CC7.1"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.applicationaccess'').objectForKey(''enforcedSoftwareUpdateDelay'')" -> n:^(\d+)$ compare <= 30'
      - 'not c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.applicationaccess'').objectForKey(''enforcedSoftwareUpdateDelay'')" -> r:\.+'

  # 1.8 Ensure the System is Managed by a Mobile Device Management (MDM) Software. (Manual) - Not Implemented

  # 2.1.1.1 Audit iCloud Keychain. (Manual) - Not Implemented
  # 2.1.1.2 Audit iCloud Drive. (Manual) - Not Implemented
  # 2.1.1.3 Ensure iCloud Drive Document and Desktop Sync Is Disabled. (Automated) - Not Implemented
  # 2.1.1.4 Audit Security Keys Used With AppleIDs. (Manual) - Not Implemented
  # 2.1.1.5 Audit Freeform Sync to iCloud. (Manual) - Not Implemented
  # 2.1.1.6 Audit Find My Mac. (Manual) - Not Implemented
  # 2.1.2 Audit App Store Password Settings. (Manual) - Not Implemented

  # 2.2.1 Ensure Firewall Is Enabled. (Automated)
  - id: 34006
    title: "Ensure Firewall Is Enabled."
    description: "A firewall is a piece of software that blocks unwanted incoming connections to a system. The socketfilter Firewall is what is used when the Firewall is turned on in the Security & Privacy Preference Pane. Logging is required to appropriately monitor what access is allowed and denied. The logs can be viewed in the macOS Unified Logs. In previous versions of macOS (prior to macOS 15 Sequoia) there was an additional step to turn on firewall logging after enabling the firewall. As of macOS 15 logging is turned on automatically without user interaction. The logging recommendation has been removed in the macOS 15 benchmark and will not be included going forward. If your organization is looking for more detailed information about network security, you will need a third-party solution."
    rationale: "A firewall minimizes the threat of unauthorized users gaining access to your system while connected to a network or the Internet."
    impact: "The firewall may block legitimate traffic. Applications that are unsigned will require special handling."
    remediation: "Graphical Method: Perform the following steps to turn the firewall on: 1. Open System Settings 2. Select Network 3. Select Firewall 4. Set Firewall to enabled Terminal Method: Run the following command to enable the firewall: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.alf globalstate -int <value> For the <value>, use either 1, specific services, or 2, essential services only. Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.security.firewall 2. The key to include is EnableFirewall 3. The key must be set to <true/>."
    references:
      - "https://support.apple.com/en-us/guide/security/seca0e83763f/web"
      - "http://support.apple.com/en-us/HT201642"
    compliance:
      - cis: ["2.2.1"]
      - cis_csc_v8: ["4.1", "4.5", "13.1"]
      - cis_csc_v7: ["5.1", "9.4", "9.5"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "AC.L1-3.1.20", "AU.L2-3.3.5", "AU.L2-3.3.6", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "SC.L1-3.13.1", "SC.L2-3.13.6", "SI.L2-3.14.3", "SI.L2-3.14.7"]
      - hipaa: ["164.312(b)"]
      - iso_27001-2013: ["A.13.1.1", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["AU-6(1)", "AU-7", "CM-7(1)", "CM-9", "IR-4(1)", "SA-10", "SC-7(5)", "SI-4(2)", "SI-4(5)"]
      - pci_dss_v3.2.1: ["1.1.4", "1.4", "10.5.3", "10.6.1", "11.5", "2.2"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.6", "1.2.7", "1.5.1", "10.7", "10.7.1", "10.7.2", "10.7.3", "11.5", "2.1.1", "2.2.1"]
      - soc_2: ["CC6.6", "CC7.1", "CC7.2", "CC8.1"]
    condition: any
    rules:
      - "c:defaults read /Library/Preferences/com.apple.alf globalstate -> r:^1$|^2$"
      - "c:defaults read /Library/Preferences/com.apple.security.firewall EnableFirewall -> r:^1$|^2$|^true$"

  # 2.2.2 Ensure Firewall Stealth Mode Is Enabled. (Automated)
  - id: 34007
    title: "Ensure Firewall Stealth Mode Is Enabled."
    description: "While in Stealth mode, the computer will not respond to unsolicited probes, dropping that traffic."
    rationale: "Stealth mode on the firewall minimizes the threat of system discovery tools while connected to a network or the Internet."
    impact: "Traditional network discovery tools like ping will not succeed. Other network tools that measure activity and approved applications will work as expected. This control aligns with the primary macOS use case of a laptop that is often connected to untrusted networks where host segregation may be non-existent. In that use case, hiding from the other inmates is likely more than desirable. In use cases where use is only on trusted LANs with static IP addresses, stealth mode may not be desirable."
    remediation: "Graphical Method: Perform the following steps to enable firewall stealth mode: 1. Open System Settings 2. Select Network 3. Select Firewall 4. Select Options... 5. Set Enabled stealth mode to enabled Terminal Method: Run the following command to enable stealth mode: $ /usr/bin/sudo /usr/libexec/ApplicationFirewall/socketfilterfw -- setstealthmode on Stealth mode enabled Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.security.firewall 2. The key to include is EnableStealthMode 3. The key must be set to <true/> Note: This key must be set in the same configuration profile with EnableFirewall set to <true/>. If it is set in its own configuration profile, it will fail."
    references:
      - "http://support.apple.com/en-us/HT201642"
    compliance:
      - cis: ["2.2.2"]
      - cis_csc_v8: ["4.1", "4.5", "4.8"]
      - cis_csc_v7: ["5.1", "9.4"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "AC.L1-3.1.20", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L1-3.13.1", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.1", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10", "SC-7(5)"]
      - pci_dss_v3.2.1: ["1.1.4", "1.1.6", "1.2.1", "1.4", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: any
    rules:
      - "c:defaults read /Library/Preferences/com.apple.alf stealthenabled -> r:^1$|^2$"
      - "c:defaults read /Library/Preferences/com.apple.security.firewall EnableStealthMode -> r:^1$|^2$|^true$"

  # 2.3.1.1 Ensure AirDrop Is Disabled When Not Actively Transferring Files. (Automated) - Not Implemented
  # 2.3.1.2 Ensure AirPlay Receiver Is Disabled. (Automated) - Not Implemented

  # 2.3.2.1 Ensure Set Time and Date Automatically Is Enabled. (Automated)
  - id: 34008
    title: "Ensure Set Time and Date Automatically Is Enabled."
    description: "Correct date and time settings are required for authentication protocols, file creation, modification dates, and log entries. Note: If your organization has internal time servers, enter them here. Enterprise mobile devices may need to use a mix of internal and external time servers. If multiple servers are required, use the Date & Time System Preference with each server separated by a space. Additional Note: The default Apple time server is time.apple.com. Variations include time.euro.apple.com. While it is certainly more efficient to use internal time servers, there is no reason to block access to global Apple time servers or to add a time.apple.com alias to internal DNS records. There are no reports that Apple gathers any information from NTP synchronization, as the computers already phone home to Apple for Apple services including iCloud use and software updates. Best practice is to allow DNS resolution to an authoritative time service for time.apple.com, preferably to connect to Apple servers, but local servers are acceptable as well."
    rationale: "Kerberos may not operate correctly if the time on the Mac is off by more than 5 minutes. This in turn can affect Apple's single sign-on feature, Active Directory logons, and other features."
    impact: "The timed service will periodically synchronize with named time servers and will make the computer time more accurate."
    remediation: "Graphical Method: Perform the following to enable the date and time to be set automatically: 1. Open System Settings 2. Select General 3. Select Date & Time 4. Set Set time and date automatically to enabled Note: By default, the operating system will use time.apple.com as the time server. You can change to any time server that meets your organization's requirements. Terminal Method: Run the following commands to enable the date and time setting automatically: $ /usr/bin/sudo /usr/sbin/systemsetup -setnetworktimeserver <your.time.server> setNetworkTimeServer: <your.time.server> $ /usr/bin/sudo /usr/sbin/systemsetup -setusingnetworktime on setUsingNetworkTime: On example: $ /usr/bin/sudo /usr/sbin/systemsetup -setnetworktimeserver time.apple.com setNetworkTimeServer: time.apple.com $ /usr/bin/sudo /usr/sbin/systemsetup -setusingnetworktime on setUsingNetworkTime: On Run the following commands if you have not set, or need to set, a new time zone: $ /usr/bin/sudo /usr/sbin/systemsetup -listtimezones $ /usr/bin/sudo /usr/sbin/systemsetup -settimezone <selected time zone> example: $ /usr/bin/sudo /usr/sbin/systemsetup -listtimezones Time Zones: Africa/Abidjan Africa/Accra Africa/Addis_Ababa ... $ /usr/bin/sudo /usr/sbin/systemsetup -settimezone America/New_York Set TimeZone: America/New_York."
    compliance:
      - cis: ["2.3.2.1"]
      - cis_csc_v8: ["8.4"]
      - cis_csc_v7: ["6.1"]
      - cmmc_v2.0: ["AU.L2-3.3.7"]
      - iso_27001-2013: ["A.12.4.4"]
      - nist_sp_800-53: ["AU-7"]
      - pci_dss_v3.2.1: ["10.4"]
      - pci_dss_v4.0: ["10.6", "10.6.1", "10.6.2", "10.6.3"]
      - soc_2: ["CC4.1", "CC5.2"]
    condition: all
    rules:
      - 'c:/usr/sbin/systemsetup -getusingnetworktime -> r:Network Time:\s*\t*On'

  # 2.3.2.2 Ensure the Time Service Is Enabled. (Automated)
  - id: 34009
    title: "Ensure the Time Service Is Enabled."
    description: "In macOS 10.14, Apple replace ntp with timed for time services, and is used to ensure correct time is kept. Correct date and time settings are required for authentication protocols, file creation, modification dates and log entries."
    rationale: "Kerberos may not operate correctly if the time on the Mac is off by more than 5 minutes. This in turn can affect Apple's single sign-on feature, Active Directory logons, and other features."
    impact: "Accurate time is required for many computer functions."
    remediation: "Run the following commands to enable the timed service: $ /usr/bin/sudo /bin/launchctl load -w /System/Library/LaunchDaemons/com.apple.timed.plist."
    compliance:
      - cis: ["2.3.2.2"]
      - cis_csc_v8: ["8.4"]
      - cis_csc_v7: ["6.1"]
      - cmmc_v2.0: ["AU.L2-3.3.7"]
      - iso_27001-2013: ["A.12.4.4"]
      - nist_sp_800-53: ["AU-7"]
      - pci_dss_v3.2.1: ["10.4"]
      - pci_dss_v4.0: ["10.6", "10.6.1", "10.6.2", "10.6.3"]
      - soc_2: ["CC4.1", "CC5.2"]
    condition: all
    rules:
      - "c:systemsetup -getnetworktimeserver -> r:Network Time Server:"

  # 2.3.3.1 Ensure DVD or CD Sharing Is Disabled. (Automated)
  - id: 34010
    title: "Ensure DVD or CD Sharing Is Disabled."
    description: "DVD or CD Sharing allows users to remotely access the system's optical drive. While Apple does not ship Macs with built-in optical drives any longer, external optical drives are still recognized when they are connected. In testing, the sharing of an external optical drive persists when a drive is reconnected."
    rationale: "Disabling DVD or CD Sharing minimizes the risk of an attacker using the optical drive as a vector for attack and exposure of sensitive data."
    impact: "Many Apple devices are now sold without optical drives, however drive sharing may be needed for legacy optical media. The media should be explicitly re-shared as needed rather than using a persistent share. Optical drives should not be used for long-term storage. To store necessary data from an optical drive it should be copied to another form of external storage. Optionally, an image can be made of the optical drive so that it is stored in its original form on another form of external storage."
    remediation: "Graphical Method: Perform the following steps to disable DVD or CD Sharing: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set DVD or CD sharing to disabled Terminal Method: Run the following command to disable DVD or CD Sharing: $ /usr/bin/sudo /bin/launchctl disable system/com.apple.ODSAgent Note: If using the Terminal method, the GUI will still show the service checked until after a reboot."
    compliance:
      - cis: ["2.3.3.1"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:sh -c "launchctl list | grep -c com.apple.ODSAgent" -> r:^0$'

  # 2.3.3.2 Ensure Screen Sharing Is Disabled. (Automated)
  - id: 34011
    title: "Ensure Screen Sharing Is Disabled."
    description: "Screen Sharing allows a computer to connect to another computer on a network and display the computer's screen. While sharing the computer's screen, the user can control what happens on that computer, such as opening documents or applications, opening, moving, or closing windows, and even shutting down the computer. While mature administration and management does not use graphical connections for standard maintenance, most help desks have capabilities to assist users in performing their work when they have technical issues and need support. Help desks use graphical remote tools to understand what the user sees and assist them so they can get back to work. For MacOS, some of these remote capabilities can use Apple's OS tools. Control is therefore not meant to prohibit the use of a just-in-time graphical view from authorized personnel with authentication controls. Sharing should not be enabled except in narrow windows when help desk support is required. Screen Sharing on macOS can allow the use of the insecure VNC protocol. VNC is a clear text protocol that should not be used on macOS."
    rationale: "Disabling Screen Sharing mitigates the risk of remote connections being made without the user of the console knowing that they are sharing the computer."
    impact: "Help desks may require the periodic use of a graphical connection mechanism to assist users. Any support that relies on native MacOS components will not work unless a scripted solution to enable and disable sharing as neccessary."
    remediation: "Graphical Method: Perform the following steps to disable Screen Sharing: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Screen Sharing to disabled Terminal Method: Run the following command to turn off Screen Sharing: $ /usr/bin/sudo /bin/launchctl disable system/com.apple.screensharing."
    references:
      - "https://support.apple.com/guide/mac-help/turn-screen-sharing-on-or-off-mh11848/mac"
    compliance:
      - cis: ["2.3.3.2"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:sh -c "launchctl list | grep -c com.apple.screensharing" -> r:^0$'

  # 2.3.3.3 Ensure File Sharing Is Disabled. (Automated)
  - id: 34012
    title: "Ensure File Sharing Is Disabled."
    description: "File sharing from a user workstation creates additional risks, such as: - Open ports are created that can be probed and attacked - Passwords are attached to user accounts for access that may be exposed and endanger other parts of the organizational environment, including directory accounts Increased complexity makes security more difficult and may expose additional attack vectors - Apple's File Sharing uses the Server Message Block (SMB) protocol to share to other computers that can mount SMB shares. This includes other macOS computers. Apple warns that SMB sharing stored passwords is less secure, and anyone with system access can gain access to the password for that account. When sharing with SMB, each user accessing the Mac must have SMB enabled. Storing passwords, especially copies of valid directory passwords, decreases security for the directory account and should not be used."
    rationale: "By disabling File Sharing, the remote attack surface and risk of unauthorized access to files stored on the system is reduced."
    impact: "File Sharing can be used to share documents with other users, but hardened servers should be used rather than user endpoints. Turning on File Sharing increases the visibility and attack surface of a system unnecessarily."
    remediation: "Graphical Method: Perform the following steps to disable File Sharing: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set File Sharing to disabled Terminal Method: Run the following command to disable File Sharing: $ /usr/bin/sudo /bin/launchctl disable system/com.apple.smbd."
    compliance:
      - cis: ["2.3.3.3"]
      - cis_csc_v8: ["4.1", "4.8", "5.4"]
      - cis_csc_v7: ["4.3", "5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "AC.L2-3.1.5", "AC.L2-3.1.6", "AC.L2-3.1.7", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.3", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3", "A.9.2.3"]
      - nist_sp_800-53: ["AC-6(2)", "AC-6(5)", "CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5", "7.1", "7.1.1", "7.1.2", "7.1.3"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.1", "CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:sh -c "launchctl list | grep -c com.apple.smbd" -> r:^0$'

  # 2.3.3.4 Ensure Printer Sharing Is Disabled. (Automated)
  - id: 34013
    title: "Ensure Printer Sharing Is Disabled."
    description: "By enabling Printer Sharing, the computer is set up as a print server to accept print jobs from other computers. Dedicated print servers or direct IP printing should be used instead."
    rationale: "Disabling Printer Sharing mitigates the risk of attackers attempting to exploit the print server to gain access to the system."
    remediation: "Graphical Method: Perform the following steps to disable Printer Sharing: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Printer Sharing to disabled Terminal Method: Run the following command to disable Printer Sharing: $ /usr/bin/sudo /usr/sbin/cupsctl --no-share-printers."
    compliance:
      - cis: ["2.3.3.4"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:sh -c "cupsctl | grep _share_printers | cut -d ''='' -f2" -> r:^0$'

  # 2.3.3.5 Ensure Remote Login Is Disabled. (Automated)
  - id: 34014
    title: "Ensure Remote Login Is Disabled."
    description: "Remote Login allows an interactive terminal connection to a computer."
    rationale: "Disabling Remote Login mitigates the risk of an unauthorized person gaining access to the system via Secure Shell (SSH). While SSH is an industry standard to connect to posix servers, the scope of the benchmark is for Apple macOS clients, not servers. macOS does have an IP-based firewall available (pf, ipfw has been deprecated) that is not enabled or configured. There are more details and links in the Network sub-section. macOS no longer has TCP Wrappers support built in and does not have strong Brute-Force password guessing mitigations, or frequent patching of openssh by Apple. Since most macOS computers are mobile workstations, managing IP-based firewall rules on mobile devices can be very resource intensive. All of these factors can be parts of running a hardened SSH server."
    impact: "The SSH server built into macOS should not be enabled on a standard user computer, particularly one that changes locations and IP addresses. A standard user that runs local applications, including email, web browser, and productivity tools, should not use the same device as a server. There are Enterprise management toolsets that do utilize SSH. If they are in use, the computer should be locked down to only respond to known, trusted IP addresses and appropriate administrator service accounts. For macOS computers that are being used for specialized functions, there are several options to harden the SSH server to protect against unauthorized access, including brute force attacks. There are some basic criteria that need to be considered: - Do not open an SSH server to the internet without controls in place to mitigate SSH brute force attacks. This is particularly important for systems bound to Directory environments. It is great to have controls in place to protect the system, but if they trigger after the user is already locked out of their account, they are not optimal. If authorization happens after authentication, directory accounts for users that don't even use the system can be locked out. - Do not use SSH key pairs when there is no insight to the security on the client system that will authenticate into the server with a private key. If an attacker gets access to the remote system and can find the key, they may not need a password or a key logger to access the SSH server. - Detailed instructions on hardening an SSH server, if needed, are available in the CIS Linux Benchmarks, but it is beyond the scope of this benchmark."
    remediation: "Perform the following to disable Remote Login: Graphical Method: Perform the following steps to disable Remote Login: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Remote Login to disabled Terminal Method: Run the following command to disable Remote Login: $ /usr/bin/sudo /usr/sbin/systemsetup -setremotelogin off Do you really want to turn remote login off? If you do, you will lose this connection and can only turn it back on locally at the server (yes/no)? Entering yes will disable remote login."
    compliance:
      - cis: ["2.3.3.5"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:systemsetup -getremotelogin -> r:Remote Login:\s*\t*Off'

  # 2.3.3.6 Ensure Remote Management Is Disabled. (Automated)
  - id: 34015
    title: "Ensure Remote Management Is Disabled."
    description: "Remote Management is the client portion of Apple Remote Desktop (ARD). Remote Management can be used by remote administrators to view the current screen, install software, report on, and generally manage client Macs. The screen sharing options in Remote Management are identical to those in the Screen Sharing section. In fact, only one of the two can be configured. If Remote Management is used, refer to the Screen Sharing section above on issues regard screen sharing. Remote Management should only be enabled when a Directory is in place to manage the accounts with access. Computers will be available on port 5900 on a macOS System and could accept connections from untrusted hosts depending on the configuration, which is a major concern for mobile systems. As with other sharing options, an open port even for authorized management functions can be attacked, and both unauthorized access and Denial-of-Service vulnerabilities could be exploited. If remote management is required, the pf firewall should restrict access only to known, trusted management consoles. Remote management should not be used across the Internet without the use of a VPN tunnel."
    rationale: "Remote Management should only be enabled on trusted networks with strong user controls present in a Directory system. Mobile devices without strict controls are vulnerable to exploit and monitoring."
    impact: "Many organizations utilize ARD for client management."
    remediation: "Graphical Method: Perform the following steps to disable Remote Management: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Remote Management to disabled Terminal Method: Run the following command to disable Remote Management: $ /usr/bin/sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources /kickstart -deactivate -stop Starting... Removed preference to start ARD after reboot. Done."
    compliance:
      - cis: ["2.3.3.6"]
      - cis_csc_v8: ["4.1", "4.8", "5.4"]
      - cis_csc_v7: ["4.3", "9.2", "14.3"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "AC.L2-3.1.5", "AC.L2-3.1.6", "AC.L2-3.1.7", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.3", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.1", "A.13.1.3", "A.9.2.3"]
      - nist_sp_800-53: ["AC-6(2)", "AC-6(5)", "CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5", "7.1", "7.1.1", "7.1.2", "7.1.3"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.1", "CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - "not p:/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/MacOS/ARDAgent"

  # 2.3.3.7 Ensure Remote Apple Events Is Disabled. (Automated)
  - id: 34016
    title: "Ensure Remote Apple Events Is Disabled."
    description: "Apple Events is a technology that allows one program to communicate with other programs. Remote Apple Events allows a program on one computer to communicate with a program on a different computer."
    rationale: "Disabling Remote Apple Events mitigates the risk of an unauthorized program gaining access to the system."
    impact: "With remote Apple events turned on, an AppleScript program running on another Mac can interact with the local computer."
    remediation: "Graphical Method: Perform the following steps to disable Remote Apple Events: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Remote Apple Events to disabled Terminal Method: Run the following commands to set Remote Apple Events to Off: $ /usr/bin/sudo /usr/sbin/systemsetup -setremoteappleevents off setremoteappleevents: Off."
    compliance:
      - cis: ["2.3.3.7"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:systemsetup -getremoteappleevents -> r:Remote Apple Events:\s*\t*Off'

  # 2.3.3.8 Ensure Internet Sharing Is Disabled. (Automated)
  - id: 34017
    title: "Ensure Internet Sharing Is Disabled."
    description: "Internet Sharing uses the open source natd process to share an internet connection with other computers and devices on a local network. This allows the Mac to function as a router and share the connection to other, possibly unauthorized, devices."
    rationale: "Disabling Internet Sharing reduces the remote attack surface of the system."
    impact: "Internet Sharing allows the computer to function as a router and other computers to use it for access. This can expose both the computer itself and the networks it is accessing to unacceptable access from unapproved devices."
    remediation: "Graphical Method: Perform the following steps to disable Internet Sharing: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Internet Sharing to disabled Terminal Method: Run the following command to turn off Internet Sharing: $ usr/bin/sudo /usr/bin/defaults write /Library/Preferences/SystemConfiguration/com.apple.nat NAT -dict Enabled -int 0 Note: Using the Terminal Method will not be reflected in the GUI, but will disable the underlying service. Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.MCX 2. The key to include is forceInternetSharingOff 3. The key must be set to <true/>."
    compliance:
      - cis: ["2.3.3.8"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: any
    rules:
      - 'not c:defaults read /Library/Preferences/SystemConfiguration/com.apple.nat -> r:Enabled\s*\t*=\s*\t*1'
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.MCX'').objectForKey(''forceInternetSharingOff'')" -> r:^true$'

  # 2.3.3.9 Ensure Content Caching Is Disabled. (Automated)
  - id: 34018
    title: "Ensure Content Caching Is Disabled."
    description: "Starting with 10.13 (macOS High Sierra), Apple introduced a service to make it easier to deploy data from Apple, including software updates, where there are bandwidth constraints to the Internet and fewer constraints or greater bandwidth exist on the local subnet. This capability can be very valuable for organizations that have throttled and possibly metered Internet connections. In heterogeneous enterprise networks with multiple subnets, the effectiveness of this capability would be determined by how many Macs were on each subnet at the time new, large updates were made available upstream. This capability requires the use of mac OS clients as P2P nodes for updated Apple content. Unless there is a business requirement to manage operational Internet connectivity and bandwidth, user endpoints should not store content and act as a cluster to provision data. Content types supported by Content Caching in macOS."
    rationale: "The main use case for Mac computers is as mobile user endpoints. P2P sharing services should not be enabled on laptops that are using untrusted networks. Content Caching can allow a computer to be a server for local nodes on an untrusted network. While there are certainly logical controls that could be used to mitigate risk, they add to the management complexity. Since the value of the service is in specific use cases, organizations with the use case described above can accept risk as necessary."
    impact: "This setting will adversely affect bandwidth usage between local subnets and the Internet."
    remediation: "Graphical Method: Perform the following steps to disable Content Caching: 1. Open System Settings 2. Select General 3. Select Sharing 4. Set Content Caching to disabled Terminal Method: Run the following command to disable Content Caching: $ /usr/bin/sudo /usr/bin/AssetCacheManagerUtil deactivate The output will include Content caching deactivated Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.applicationaccess 2. The key to include is allowContentCaching 3. The key must be set to <false/>."
    references:
      - "https://support.apple.com/guide/mac-help/about-content-caching-mchl9388ba1b/"
      - "https://support.apple.com/guide/mac-help/set-up-content-caching-on-mac-mchl3b6c3720/"
    compliance:
      - cis: ["2.3.3.9"]
      - cis_csc_v8: ["4.8"]
      - cis_csc_v7: ["9.2"]
      - cmmc_v2.0: ["CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.2.5", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.AssetCache'').objectForKey(''Activated'')" -> r:^0$'
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.applicationaccess'').objectForKey(''allowContentCaching'')" -> r:^0$|^true$'

  # 2.3.3.10 Ensure Media Sharing Is Disabled. (Automated) - Not Implemented
  # 2.3.3.11 Ensure Bluetooth Sharing Is Disabled. (Automated) - Not Implemented
  # 2.3.3.12 Ensure Computer Name Does Not Contain PII or Protected Organizational Information. (Manual) - Not Implemented

  # 2.3.4.1 Ensure Backup Automatically is Enabled If Time Machine Is Enabled. (Automated)
  - id: 34019
    title: "Ensure Backup Automatically is Enabled If Time Machine Is Enabled."
    description: 'Backup solutions are only effective if the backups run on a regular basis. The time to check for backups is before the hard drive fails or the computer goes missing. In order to simplify the user experience so that backups are more likely to occur, Time Machine should be on and set to Back Up Automatically whenever the target volume is available. Operational staff should ensure that backups complete on a regular basis and the backups are tested to ensure that file restoration from backup is possible when needed. Backup dates are available even when the target volume is not available in the Time Machine plist. SnapshotDates = ( "2012-08-20 12:10:22 +0000", "2013-02-03 23:43:22 +0000", "2014-02-19 21:37:21 +0000", "2015-02-22 13:07:25 +0000", "2016-08-20 14:07:14 +0000" When the backup volume is connected to the computer, more extensive information is available through tmutil. See man tmutil.'
    rationale: "Backups should automatically run whenever the backup drive is available."
    impact: "The backup will run periodically in the background and could have user impact while running."
    remediation: "Graphical Method: Perform the following steps to enable Time Machine automatic backup: 1. Open System Settings 2. Select General 3. Select Time Machine 4. Select Options... 5. Set Back up frequency to Automatically <every hour/every day/every week> Terminal Method: Run the following command to enable automatic backups if Time Machine is enabled: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.TimeMachine.plist AutoBackup -bool true Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.MCX.TimeMachine 2. The key to include is AutoBackup 3. The key must be set to."
    compliance:
      - cis: ["2.3.4.1"]
      - cis_csc_v8: ["11.2"]
      - cis_csc_v7: ["10.1"]
      - hipaa: ["164.308(a)(7)(ii)(A)"]
      - iso_27001-2013: ["A.12.3.1"]
      - pci_dss_v3.2.1: ["12.10.1"]
    condition: any
    rules:
      - 'c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.TimeMachine'').objectForKey(''AutoBackup'')" -> r:^1$'
      - 'not c:osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.TimeMachine'').objectForKey(''LastDestinationID'')" -> r:^\.+$'

  # 2.3.4.2 Ensure Time Machine Volumes Are Encrypted If Time Machine Is Enabled. (Automated)
  - id: 34020
    title: "Ensure Time Machine Volumes Are Encrypted If Time Machine Is Enabled."
    description: "One of the most important security tools for data protection on macOS is FileVault. With encryption in place, it makes it difficult for an outside party to access your data if they get physical possession of the computer. One very large weakness in data protection with FileVault is the level of protection on backup volumes. If the internal drive is encrypted but the external backup volume that goes home in the same laptop bag is not, it is self-defeating. Apple tries to make this mistake easily avoided by providing a checkbox to enable encryption when setting up a Time Machine backup. Using this option does require some password management, particularly if a large drive is used with multiple computers. A unique, complex password to unlock the drive can be stored in keychains on multiple systems for ease of use. While some portable drives may contain non-sensitive data and encryption may make interoperability with other systems difficult, backup volumes should be protected just like boot volumes."
    rationale: "Backup volumes need to be encrypted."
    remediation: "Graphical Method: Perform the following steps to enable encryption on the Time Machine drive: 1. Open System Settings 2. Select General 3. Select Time Machine 4. Select the unencrypted drive 5. Select - to forget that drive as a destination 6. Select + to add a different drive as the destination 7. Select Set Up Disk... 8. Set Encrypt Backup to enabled 9. Enter a password in the New Password and the same password in the Re-enter Password fields 10. A password hint is required, but it is recommended that you do not use any identifying information for the password Note: In macOS 12.0 Monterey and previous, the existing Time Machine drive could have encryption added without formatting it. This is no longer possible in macOS 13.0 Ventura. If you wish to keep previous backups from the unencrypted volume, you will need to manually move those files over to the new encrypted drive."
    compliance:
      - cis: ["2.3.4.2"]
      - cis_csc_v8: ["3.6", "3.11", "11.3"]
      - cis_csc_v7: ["10.4", "13.6", "14.8"]
      - cmmc_v2.0: ["AC.L2-3.1.19", "IA.L2-3.5.10", "MP.L2-3.8.1", "MP.L2-3.8.9", "SC.L2-3.13.11", "SC.L2-3.13.16"]
      - hipaa: ["164.312(a)(2)(iv)", "164.312(e)(2)(ii)"]
      - iso_27001-2013: ["A.10.1.1", "A.12.3.1", "A.6.2.1"]
      - nist_sp_800-53: ["CP-9(8)", "SC-28", "SC-28(1)"]
      - pci_dss_v3.2.1: ["3.4", "3.4.1", "8.2.1", "9.5", "9.5.1"]
      - pci_dss_v4.0: ["3.1.1", "3.3.2", "3.3.3", "3.5.1", "3.5.1.2", "3.5.1.3", "8.3.2"]
      - soc_2: ["A1.2", "CC6.1", "CC6.4", "CC6.7"]
    condition: all
    rules:
      - 'c: sh -c "defaults read /Library/Preferences/com.apple.TimeMachine.plist | grep -c NotEncrypted" -> r:^0$'

  # 2.4.1 Ensure Show Wi-Fi status in Menu Bar Is Enabled. (Automated) - Not Implemented
  # 2.4.2 Ensure Show Bluetooth Status in Menu Bar Is Enabled. (Automated) - Not Implemented
  # 2.5.1 Audit Siri Settings. (Manual) - Not Implemented
  # 2.5.2 Ensure Listen for (Siri) Is Disabled. (Manual) - Not Implemented

  # 2.6.1.1 Ensure Location Services Is Enabled. (Automated)
  - id: 34021
    title: "Ensure Location Services Is Enabled."
    description: "macOS uses location information gathered through local Wi-Fi networks to enable applications to supply relevant information to users. With the operating system verifying the location, users do not need to change the time or the time zone. The computer will change them based on the user's location. They do not need to specify their location for weather or travel times, and they will receive alerts on travel times to meetings and appointments where location information is supplied. Location Services simplify some processes with mobile computers, such as asset management and time or log management. There are some use cases where it is important that the computer not be able to report its exact location. While the general use case is to enable Location Services, it should not be allowed if the physical location of the computer and the user should not be public knowledge."
    rationale: "Location Services are helpful in most use cases and can simplify log and time management where computers change time zones."
    remediation: "Graphical Method: Perform the following steps to enable Location Services: 1. Open System Settings 2. Select Privacy & Security 3. Select Location Services 4. Set Location Services to enabled Terminal Method: Run the following command to enable Location Services: $ /usr/bin/sudo /bin/launchctl load -w /System/Library/LaunchDaemons/com.apple.locationd.plist If the com.apple.locationd.plist outputs 0, run the following command to also ensure Location Services is running: $ /usr/bin/sudo /usr/bin/defaults write /var/db/locationd/Library/Preferences/ByHost/com.apple.locationd LocationServicesEnabled -bool false $ /usr/bin/sudo /bin/launchctl kickstart -k system/com.apple.locationd Note: In some use cases, organizations may not want Location Services running. To disable Location Services, System Integrity Protection must be disabled."
    references:
      - "https://support.apple.com/en-us/HT204690"
    compliance:
      - cis: ["2.6.1.1"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:sh -c "launchctl list | grep -c com.apple.locationd" -> r:^1$'
      - 'c:sudo -u _locationd /usr/bin/osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.locationd'').objectForKey(''LocationServicesEnabled'')" -> r:^1$'

  # 2.6.1.2 Ensure 'Show Location Icon in Control Center when System Services Request Your Location' Is Enabled. (Automated)
  - id: 34022
    title: "Ensure 'Show Location Icon in Control Center when System Services Request Your Location' Is Enabled."
    description: "This setting provides the user an understanding of the current status of Location Services and which applications are using it."
    rationale: 'Apple has fully integrated location services into macOS. When user applications access location an arrow is displayed next to the Control Center in the menu bar to give users an indication when their location is being accessed. By default system services like Time zones, weather, travel times, geolocation, "Find my Mac,"and advertising services do not indicate the location is accessed. Enabling the "Show location icon in the menu bar when System Services request your location" setting will show an arrow in the control center when a system service accesses the location. Although an indication that location was accessed, Control Center will only say that it was accessed by "System Services" and not the individual service. Looking in System Settings > Location Services > System Services > Details... will expose exactly which system services have accessed Location Services in the last 24 hours. Third-party tools will be shown individually when they access location services.'
    impact: "Users may be provided visibility to a setting they cannot control if organizations control Location Services globally by policy."
    remediation: "Graphical Method: Perform the following steps to set whether the location services icon is in the menu bar: 1. Open System Settings 2. Select Privacy & Security 3. Select Location Services 4. Select Details... 5. Set Show location icon in menu bar when System Services request your location to enabled Terminal Method: Run the following commands to set the option of the location services icon being in the menu bar: $ /usr/bin/sudo /usr/bin/defaults write /Library/Preferences/com.apple.locationmenu.plist ShowSystemServices -bool true."
    compliance:
      - cis: ["2.6.1.2"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - "c:defaults read /Library/Preferences/com.apple.locationmenu.plist ShowSystemServices -> r:^1$|^true$"

  # 2.6.1.3 Audit Location Services Access. (Manual) - Not Implemented
  # 2.6.2.1 Audit Full Disk Access for Applications. (Manual) - Not Implemented
  # 2.6.3 Ensure Sending Diagnostic and Usage Data to Apple Is Disabled. (Automated) - Not Implemented
  # 2.6.4 Ensure Limit Ad Tracking Is Enabled. (Automated) - Not Implemented

  # 2.6.5 Ensure Gatekeeper Is Enabled. (Automated)
  - id: 34023
    title: "Ensure Gatekeeper Is Enabled."
    description: "Gatekeeper is Apple's application that utilizes allowlisting to restrict downloaded applications from launching. It functions as a control to limit applications from unverified sources from running without authorization. In an update to Gatekeeper in macOS 13 Ventura, Gatekeeper checks every application on every launch, not just quarantined apps."
    rationale: "Disallowing unsigned software will reduce the risk of unauthorized or malicious applications from running on the system."
    remediation: "Graphical Method: Perform the following steps to enable Gatekeeper: 1. Open System Settings 2. Select Privacy & Security 3. Set 'Allow apps downloaded from' to 'App Store and identified developers' Terminal Method: Run the following command to enable Gatekeeper to allow applications from App Store and identified developers: $ /usr/bin/sudo /usr/sbin/spctl --master-enable Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.systempolicy.control 2. The key to include is AllowIdentifiedDevelopers 3. The key must be set to <true/> 4. The key to also include is EnableAssessment 5. The key must be set to <true/>."
    compliance:
      - cis: ["2.6.5"]
      - cis_csc_v8: ["10.1", "10.2", "10.5"]
      - cis_csc_v7: ["8.2", "8.4"]
      - cmmc_v2.0: ["SI.L1-3.14.2", "SI.L1-3.14.4"]
      - hipaa: ["164.308(a)(5)(ii)(B)"]
      - iso_27001-2013: ["A.12.2.1"]
      - nist_sp_800-53: ["SI-16"]
      - pci_dss_v3.2.1: ["1.4", "11.4", "5.1", "5.1.1", "5.2"]
      - pci_dss_v4.0: ["5.1.1", "5.2.1", "5.2.2", "5.3.1", "5.3.2"]
      - soc_2: ["CC6.8"]
    condition: all
    rules:
      - "c:spctl --status -> r:^assessments enabled"

  # 2.6.6 Ensure FileVault Is Enabled. (Automated)
  - id: 34024
    title: "Ensure FileVault Is Enabled."
    description: "FileVault secures a system's data by automatically encrypting its boot volume and requiring a password or recovery key to access it. FileVault should be used with a saved escrow key to ensure that the owner can decrypt their data if the password is lost. FileVault may also be enabled using command line using the fdesetup command. To use this functionality, consult the Der Flounder blog for more details (see link below under References)."
    rationale: "Encrypting sensitive data minimizes the likelihood of unauthorized users gaining access to it."
    impact: "Mounting a FileVault encrypted volume from an alternate boot source will require a valid password to decrypt it."
    remediation: "Graphical Method: Perform the following steps to enable FileVault: 1. Open System Settings 2. Select Security & Privacy 3. Select Turn On... Note: This will allow you to create a recovery key for FileVault. Keep the key saved securely in case it is needed at a later date. Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.MCX 2. The key to include is dontAllowFDEDisable 3. The key must be set to <true/> Note: This profile is required to pass the audit."
    references:
      - "https://derflounder.wordpress.com/2015/02/02/managing-yosemites-filevault-2-with-fdesetup/"
      - "https://derflounder.wordpress.com/2019/01/15/unlock-or-decrypt-your-filevault-encrypted-boot-drive-from-the-command-line-on-macos-mojave/"
      - "https://derflounder.wordpress.com/2021/10/29/use-of-filevault-institutional-recovery-keys-no-longer-recommended-by-apple/"
      - "https://support.apple.com/guide/security/passcodes-and-passwords-sec20230a10d/1/web/1"
    compliance:
      - cis: ["2.6.6"]
      - cis_csc_v8: ["3.6", "3.11"]
      - cis_csc_v7: ["13.6", "14.8"]
      - cmmc_v2.0: ["AC.L2-3.1.19", "IA.L2-3.5.10", "MP.L2-3.8.1", "SC.L2-3.13.11", "SC.L2-3.13.16"]
      - hipaa: ["164.312(a)(2)(iv)", "164.312(e)(2)(ii)"]
      - iso_27001-2013: ["A.10.1.1", "A.6.2.1"]
      - nist_sp_800-53: ["SC-28", "SC-28(1)"]
      - pci_dss_v3.2.1: ["3.4", "3.4.1", "8.2.1"]
      - pci_dss_v4.0: ["3.1.1", "3.3.2", "3.3.3", "3.5.1", "3.5.1.2", "3.5.1.3", "8.3.2"]
      - soc_2: ["CC6.1"]
    condition: all
    rules:
      - "c:fdesetup status -> r:^FileVault is On"
      - 'c:osascript -l JavaScript -e "osascript -l JavaScript -e "$.NSUserDefaults.alloc.initWithSuiteName(''com.apple.MCX'').objectForKey(''dontAllowFDEDisable'')" -> r:^0$'

  # 2.6.7 Audit Lockdown Mode. (Manual) - Not Implemented

  # 2.6.8 Ensure an Administrator Password Is Required to Access System-Wide Preferences. (Automated)
  - id: 34025
    title: "Ensure an Administrator Password Is Required to Access System-Wide Preferences."
    description: "System Preferences controls system and user settings on a macOS Computer. System Preferences allows the user to tailor their experience on the computer as well as allowing the System Administrator to configure global security settings. Some of the settings should only be altered by the person responsible for the computer."
    rationale: "By requiring a password to unlock system-wide System Preferences, the risk of a user changing configurations that affect the entire system is mitigated and requires an admin user to re-authenticate to make changes."
    remediation: "Graphical Method: Perform the following steps to verify that an administrator password is required to access system-wide preferences: 1. Open System Settings 2. Select Privacy & Security 3. Select Advanced 4. Set Require an administrator password to access system-wide settings to enabled. Terminal Method: The authorizationdb settings cannot be written to directly, so the plist must be exported out to temporary file. Changes can be made to the temporary plist, then imported back into the authorizationdb settings. Run the following commands to enable that an administrator password is required to access system-wide preferences: $ /usr/bin/sudo /usr/bin/security authorizationdb read system.preferences > /tmp/system.preferences.plist YES (0) $ /usr/bin/sudo /usr/bin/defaults write /tmp/system.preferences.plist shared -bool false $ /usr/bin/sudo /usr/bin/security authorizationdb write system.preferences < /tmp/system.preferences.plist YES (0)."
    impact: "Users will need to enter their password to unlock some additional preference panes that are unlocked by default like Network, Startup and Printers & Scanners."
    compliance:
      - cis: ["2.6.8"]
      - cis_csc_v8: ["4.1"]
      - cis_csc_v7: ["5.1"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7"]
      - iso_27001-2013: ["A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["11.5", "2.2"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1"]
      - soc_2: ["CC7.1", "CC8.1"]
    condition: all
    rules:
      - "c:security authorizationdb read system.preferences | grep -A1 shared -> r:>false<"

  # 2.7.1 Ensure Screen Saver Corners Are Secure. (Automated) - Not Implemented
  # 2.8.1 Audit Universal Control Settings. (Manual) - Not Implemented
  # 2.9.1.1 Ensure the OS Is Not Active When Resuming from Standby (Intel). (Automated) - Not Implemented
  # 2.9.1.2 Ensure the OS Is Not Active When Resuming from Sleep and Display Sleep (Apple Silicon). (Automated) - Not Implemented

  # 2.9.1.3 Ensure FileVault is Locked on Sleep. (Automated)
  - id: 34026
    title: "Ensure FileVault is Locked on Sleep."
    description: "Full Disk Encryption (FDE) is a Data-at-Rest (DAR) solution. It ensures that when the data on the drive is not in use it is full encrypted, but it can be decrypted (unlocked) as needed. When a Mac sleeps, the encryption keys remain in memory so that the drive is encrypted but unlocked. There are attacks available to interact with the OS and data on the unlocked drive. FileVault volumes should be locked when not in use to resist attack."
    rationale: "The purpose of DAR is to ensure data is encrypted while at rest. If the volume is always unlocked it is not sufficient."
    impact: "The laptop will require a user to log in with their username and password, not TouchID, into the OS after the FileVault key is destroyed."
    remediation: "Terminal Method: Run the following command to ensure FileVault keys are set to be destroyed on standby: $ /usr/bin/sudo /usr/bin/pmset -a destroyfvkeyonstandby 1."
    compliance:
      - cis: ["2.9.1.3"]
      - cis_csc_v8: ["4.1"]
      - cis_csc_v7: ["16.11"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7"]
      - iso_27001-2013: ["A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["11.5", "2.2"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1"]
      - soc_2: ["CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'c:pmset -b -g -> r:^\s*\t*DestroyFVKeyOnStandby\s*\t*1'

  # 2.9.2 Ensure Power Nap Is Disabled for Intel Macs. (Automated)
  - id: 34027
    title: "Ensure Power Nap Is Disabled for Intel Macs."
    description: "Power Nap allows the system to stay in low power mode, especially while on battery power, and periodically connect to previously known networks with stored credentials for user applications to phone home and get updates. This capability requires FileVault to remain unlocked and the use of previously joined networks to be risk accepted based on the SSID without user input. This control has been updated to check the status on both battery and AC Power. The presence of an electrical outlet does not completely correlate with logical and physical security of the device or available networks."
    rationale: "Disabling this feature mitigates the risk of an attacker remotely waking the system and gaining access. The use of Power Nap adds to the risk of compromised physical and logical security. The user should be able to decrypt FileVault and have the applications download what is required when the computer is actively used. The control to prevent computer sleep has been retired for this version of the Benchmark. Forcing the computer to stay on and use energy in case a management push is needed is contrary to most current management processes. Only keep computers unslept if after hours pushes are required on closed LANs."
    impact: "Power Nap exists for unattended user application updates like email and social media clients. With Power Nap disabled, the computer will not wake and reconnect to known wireless SSIDs intermittently when slept."
    remediation: "Graphical Method: Perform the following steps to disable Power Nap: Desktop Instructions: 1. Open System Settings 2. Select Energy Saver 3. Set Power Nap to disabled 4. Select UPS (if applicable) 5. Set Power Nap to disabled Laptop Instructions: 1. Open System Settings 2. Select Battery 3. Select Power Adapter (for laptops only) 4. Set Power Nap to disabled 5. Select Battery 6. Set Power Nap to disabled 7. Select UPS (if applicable) 8. Set Power Nap to disabled Terminal Method: Run the following command to disable Power Nap: $ /usr/bin/sudo /usr/bin/pmset -a powernap 0."
    compliance:
      - cis: ["2.9.2"]
      - cis_csc_v8: ["4.1", "4.8"]
      - cis_csc_v7: ["5.1", "9.2"]
      - cmmc_v2.0: ["AC.L1-3.1.1", "AC.L1-3.1.2", "CM.L2-3.4.1", "CM.L2-3.4.2", "CM.L2-3.4.6", "CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3", "A.14.2.5", "A.8.1.3"]
      - nist_sp_800-53: ["CM-7(1)", "CM-9", "SA-10"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "11.5", "2.2", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.1.1", "1.2.1", "1.2.5", "1.2.6", "1.2.7", "1.5.1", "2.1.1", "2.2.1", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6", "CC7.1", "CC8.1"]
    condition: all
    rules:
      - 'not c:sh -c "pmset -g custom" -> r:^\s*\t*powernap\s*\t*1'

  # 2.9.3 Ensure Wake for Network Access Is Disabled. (Automated)
  - id: 34028
    title: "Ensure Wake for Network Access Is Disabled."
    description: "This feature allows the computer to take action when the user is not present and the computer is in energy saving mode. These tools require FileVault to remain unlocked and fully rejoin known networks. This macOS feature is meant to allow the computer to resume activity as needed regardless of physical security controls. This feature allows other users to be able to access your computer's shared resources, such as shared printers or Apple Music playlists, even when your computer is in sleep mode. In a closed network when only authorized devices could wake a computer, it could be valuable to wake computers in order to do management push activity. Where mobile workstations and agents exist, the device will more likely check in to receive updates when already awake. Mobile devices should not be listening for signals on any unmanaged network or where untrusted devices exist that could send wake signals."
    rationale: "Disabling this feature mitigates the risk of an attacker remotely waking the system and gaining access."
    impact: "Management programs like Apple Remote Desktop Administrator use wake-on-LAN to connect with computers. If turned off, such management programs will not be able to wake a computer over the LAN. If the wake-on-LAN feature is needed, do not turn off this feature. The control to prevent computer sleep has been retired for this version of the Benchmark. Forcing the computer to stay on and use energy in case a management push is needed is contrary to most current management processes. Only keep computers unslept if after hours pushes are required on closed LANs."
    remediation: "Graphical Method: Perform the following steps to disable Wake for network access: Desktop Instructions: 1. Open System Settings 2. Select Energy Saver 3. Set Wake for network access to disabled Laptop Instructions: 1. Open System Settings 2. Select Battery 3. Select Options... 4. Set Wake for network access to Never Terminal Method: Run the following command to disable Wake for network access: $ /usr/bin/sudo /usr/bin/pmset -a womp 0 Profile Method: Create or edit a configuration profile with the following information: 1. The PayloadType string is com.apple.MCX 2. The key to include is com.apple.EnergySaver.desktop.ACPower 3. The key must be set to: <dict> <key>Wake On LAN</key> <integer>0</integer> <key>Wake On Modem Ring</key> <integer>0</integer> </dict> 4. The key to also include is com.apple.EnergySaver.portable.ACPower 5. The key must be set to: <dict> <key>Wake On LAN</key> <integer>0</integer> <key>Wake On Modem Ring</key> <integer>0</integer> </dict> 6. The key to also include is com.apple.EnergySaver.portable.BatteryPower 7. The key must be set to: <dict> <key>Wake On LAN</key> <integer>0</integer> <key>Wake On Modem Ring</key> <integer>0</integer> </dict> Note: Both Wake on LAN and Wake on Modem Ring need to be set. Only setting Wake On LAN will allow the profile to install but not set any settings. This profile will only apply the setting at installation and is not sticky."
    compliance:
      - cis: ["2.9.3"]
      - cis_csc_v8: ["4.8"]
      - cis_csc_v7: ["9.2"]
      - cmmc_v2.0: ["CM.L2-3.4.7", "CM.L2-3.4.8", "SC.L2-3.13.6"]
      - iso_27001-2013: ["A.13.1.3"]
      - pci_dss_v3.2.1: ["1.1.6", "1.2.1", "2.2.2", "2.2.5"]
      - pci_dss_v4.0: ["1.2.5", "2.2.4", "6.4.1"]
      - soc_2: ["CC6.3", "CC6.6"]
    condition: any
    rules:
      - 'not c:sh -c "pmset -g custom" -> r:^\s*\t*womp\s*\t*1'
      - 'not c:sh -c "profiles -P -o stdout | grep ''Wake On LAN''" -> n:=\s*(\d) compare != 0'
      - 'not c:sh -c "profiles -P -o stdout | grep ''Wake On Modem Ring''" -> n:=\s*(\d) compare != 0'