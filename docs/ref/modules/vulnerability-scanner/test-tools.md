# Test tools

Below there is a quick overview on how to use the vulnerability scanner command line tools that serve the purpose of debugging and testing. 

These tools ease the task of mocking and replicating a real environment where we can validate that new changes do not affect in an undesired way the current capabilities of the module. 

## Compilation 

Command line test tools are intended for development purposes and they are not delivered in the Wazuh manager packages. To use them, it is required to compile the project by sources.

```console
cd wazuh/src
make deps 
make -j$(nproc) TARGET=server
``` 

## Vulnerability Scanner tool 

- Path 
```console
src/build/wazuh_modules/vulnerability_scanner/testtool/scanner/vd_scanner_testtool
```

**Note**: execute the cli with --help to display the available options.

### Database creation 

- Command
```console
src/build/wazuh_modules/vulnerability_scanner/testtool/scanner/vd_scanner_testtool -c config.json -d
```

- config.json
```json
{
  "vulnerability-detection": {
    "enabled": "yes",
    "index-status": "no",
    "cti-url": "https://cti.wazuh.com/api/v1/catalog/contexts/vd_1.0.0/consumers/vd_4.8.0"
  },
  "clusterName": "cluster01",
  "clusterEnabled": false
}
```

The **-d** flag performs a snapshot download from CTI to create a local database.

In a real Wazuh Manager installation, **clusterName** is the hostname for a single node deployment, or the cluster name for a cluster setup.

The outcome of this command is a RocksDB CVE database **queue** in the current directory. 

### Detection 

For details about event format please refer to [events format](events.md)

- Command
```console
scanner/vd_scanner_testtool -c config.json -u -i os.json,package.json
```

**Note**: A package event needs a OS event, if we send a package event without the os event, the tool may hang even if we later use the right command with OS event. To overcome this, remove the **queue/vd/event**

### Mocking Wazuh-DB information

As previously mentioned, the scanner requires OS and hotfixes information for detection. That could be mocked using the options **-h** for hotfixes and **-b** for OS. 

- Example hotfix mocked data
```json
{
  "001": [
      { "hotfix":"KB2468871" },
      { "hotfix":"KB2478063" },
      { "hotfix":"KB2533523" },
      { "hotfix":"KB2544514" },
      { "hotfix":"KB2600211" },
      { "hotfix":"KB2600217" },
      { "hotfix":"KB4502496" },
      { "hotfix":"KB4512577" },
      { "hotfix":"KB4512578" },
      { "hotfix":"KB4514366" },
      { "hotfix":"KB4535680" },
      { "hotfix":"KB4535684" },
      { "hotfix":"KB4535685" },
      { "hotfix":"KB4577586" },
      { "hotfix":"KB4580325" },
      { "hotfix":"KB4589208" },
      { "hotfix":"KB4601558" },
      { "hotfix":"KB5003171" },
      { "hotfix":"KB5003243" },
      { "hotfix":"KB5034619" },
      { "hotfix":"KB5034768" },
      { "hotfix":"KB5034863" },
      { "hotfix":"KB5012649"}
  ]
}
```

- Example OS mocked data for Ubuntu
```json
{
    "001": {
        "architecture": "x86_64",
        "checksum": "1704514361693635656",
        "hostname": "ubuntu-jammy",
        "os_codename": "jammy",
        "os_major": "22",
        "os_minor": "04",
        "os_name": "Ubuntu",
        "os_patch": "3",
        "os_platform": "ubuntu",
        "os_version": "22.04.3 LTS (Jammy Jellyfish)",
        "reference": "f22553c945b045bfc0d162cb890344d2f4fa8609",
        "release": "5.15.0-91-generic",
        "scan_id": 0,
        "scan_time": "2024/01/06 04:12:44",
        "sysname": "Linux",
        "version": "#101-Ubuntu SMP Tue Nov 14 13:30:08 UTC 2023"
    }
}
```

## RocksDB tool 

- Path
```console
src/build/wazuh_modules/vulnerability_scanner/testtool/rocksDBQuery/rocks_db_query_testtool
```

**Note**: execute the cli with --help to display the available options.

### Inspect databases 

Indexer databases 

- Commands
```console
rocksDBQuery/rocks_db_query_testtool -d queue/indexer/db/wazuh-states-vulnerabilities-<hostname>
rocksDBQuery/rocks_db_query_testtool -d queue/indexer/wazuh-states-vulnerabilities-<hostname>
```

Example output
```console
001_f21aca719022f009d80bbf9224741d79029b31f2_CVE-2024-12243 ==> 
{
  "agent": {
    "id": "001",
    "type": "Wazuh",
    "version": "v4.10.1"
  },
  "host": {
    "os": {
      "full": "CentOS Stream 9",
      "kernel": "5.14.0-391.el9.x86_64",
      "name": "CentOS Stream",
      "platform": "centos",
      "type": "centos",
      "version": "9"
    }
  },
  "package": {
    "architecture": "x86_64",
    "name": "gnutls",
    "size": 0,
    "type": "rpm",
    "version": "3.8.2-1.el9"
  },
  "vulnerability": {
    "category": "Packages",
    "classification": "-",
    "description": "DOCUMENTATION: A flaw was found in GnuTLS, which relies on libtasn1 for ASN.1 data processing. Due to an inefficient algorithm in libtasn1, decoding certain DER-encoded certificate data can take excessive time, leading to increased resource consumption. This flaw allows a remote attacker to send a specially crafted certificate, causing GnuTLS to become unresponsive or slow, resulting in a denial-of-service condition.",
    "detected_at": "2025-04-25T18:49:27.929Z",
    "enumeration": "CVE",
    "id": "CVE-2024-12243",
    "published_at": "2025-02-10T16:15:37Z",
    "reference": "https://access.redhat.com/security/cve/CVE-2024-12243",
    "scanner": {
      "source": "Red Hat CVE Database",
      "vendor": "Wazuh"
    },
    "score": {
      "base": 5.3,
      "version": "3.1"
    },
    "severity": "Medium",
    "under_evaluation": false
  },
  "wazuh": {
    "cluster": {
      "name": "cluster01"
    },
    "schema": {
      "version": "1.0.0"
    }
  }
}
```

Inventory database

- Command 
```console
rocksDBQuery/rocks_db_query_testtool -d queue/inventory
```

Example output
```console
001_f21aca719022f009d80bbf9224741d79029b31f2 ==> CVE-2024-28835,CVE-2024-28834,CVE-2024-12243
```
